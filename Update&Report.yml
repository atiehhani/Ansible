- name: update and check services
  hosts: webservers
  become: yes
  vars:
    report_file: "/tmp/update_status_report.log"
    email_to: "admin@example.com"

  tasks:

    - name: create new log file
      copy:
        content: "ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ± {{ inventory_hostname }} \n"
        dest: "{{ report_file }}"
        force: yes

    - name: update packages
      apt:
        update_cache: yes
        upgrade: dist
      when: ansible_os_family == "Debian"
      register: update_result

    - name: register result of update 
      lineinfile:
        path: "{{ report_file }}"
        line: "âœ… Ù†ØªÛŒØ¬Ù‡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: {{ update_result.stdout_lines | default('Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª') }}"

    - name: check nginx status
      service:
        name: nginx
        state: started
      register: nginx_status
      ignore_errors: true

    - name: register status of nginx
      lineinfile:
        path: "{{ report_file }}"
        line: "ğŸ“Œ ÙˆØ¶Ø¹ÛŒØª NGINX: {{ 'ÙØ¹Ø§Ù„' if nginx_status.state == 'started' else 'ØºÛŒØ±ÙØ¹Ø§Ù„' }}"

    - name: Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø±ÙˆÛŒØ³ mysql
      service:
        name: mysql
        state: started
      register: mysql_status
      ignore_errors: true

    - name: Ø«Ø¨Øª ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³ mysql
      lineinfile:
        path: "{{ report_file }}"
        line: "ğŸ“Œ ÙˆØ¶Ø¹ÛŒØª MySQL: {{ 'ÙØ¹Ø§Ù„' if mysql_status.state == 'started' else 'ØºÛŒØ±ÙØ¹Ø§Ù„' }}"

    - name: Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø§ÛŒÙ…ÛŒÙ„
      shell: "mail -s 'ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ {{ inventory_hostname }}' {{ email_to }} < {{ report_file }}"
      ignore_errors: true
